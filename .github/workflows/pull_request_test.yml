name: PR Test

on:
    pull_request_target:
        branches:
            - main
            - develop
        types:
            - opened
            - synchronize
            - reopened

jobs:
    labeling:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Check Labels
              id: labeler
              uses: jimschubert/labeler-action@v1 # This action references .github/labeler.yml file
              with:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

    CITest:
        permissions:
            pull-requests: write
            checks: write
            contents: read

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4.2.2

            - name: Set up JDK 17
              uses: actions/setup-java@v4.7.0
              with:
                  java-version: '17'
                  distribution: 'temurin'

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Test with Gradle
              run: ./gradlew clean totalCITest


    codeql:
        depends-on: CITest

        permissions:
            actions: read            # default action permission
            contents: read           # code checkout permission
            security-events: write   # code scan permission

        name: “Perform CodeQL Analysis”
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v3

            -   name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                    languages: java

            -   name: Autobuild
                uses: github/codeql-action/autobuild@v3

            -   name: Run CodeQL Analysis
                uses: github/codeql-action/analyze@v3